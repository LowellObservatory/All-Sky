
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>protoLoFits &#8212; allsky 1.0.5 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">all</span><span id="logotext2">sky</span><span id="logotext3">:docs</span></a>
  <ul>
    <!--
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    -->
    <li><a title="General Index" href="../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../index.html">allsky 1.0.5 documentation</a>
	 &#187;
      </li>
      <li><a href="index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for protoLoFits</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/home/sel/anaconda3/bin/python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">protoLoFits and the MessageInterface class make stomp messaging available</span>
<span class="sd">to the camera module.</span>

<span class="sd">In addition to providing an ActiveMQ messaging interface, protoLoFits is</span>
<span class="sd">primarily responsible for populating FITS headers to include pertinent</span>
<span class="sd">information as of the time of data acquisition.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">BrokerComm</span> <span class="k">import</span> <span class="n">BrokerComm</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.io.fits</span> <span class="k">import</span> <span class="n">ImageHDU</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">AltAz</span><span class="p">,</span> <span class="n">get_sun</span><span class="p">,</span> <span class="n">get_moon</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">Et</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">getmtime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">asc_logger</span> <span class="k">import</span> <span class="n">log_obj</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="k">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_DFL</span>
<span class="kn">from</span> <span class="nn">astroplan</span> <span class="k">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">scheduler</span> <span class="k">import</span> <span class="n">ObsScheduler</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_DFL</span><span class="p">)</span>


<div class="viewcode-block" id="MessageInterface"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface">[docs]</a><span class="k">class</span> <span class="nc">MessageInterface</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    brokerMessage : str</span>
<span class="sd">        variable to hold the string message body portion of a </span>
<span class="sd">        stomp message</span>

<span class="sd">    seqno : str</span>
<span class="sd">        The sequence number variable held as a string</span>

<span class="sd">    seqnum : str</span>
<span class="sd">        The sequence number variable whose purpose differs from</span>
<span class="sd">        seqno</span>

<span class="sd">    basedir : str</span>
<span class="sd">        The directory path base which is typically the user home</span>
<span class="sd">        directory</span>

<span class="sd">    utdate : str</span>
<span class="sd">        The year, month and day portion of the current UT date</span>

<span class="sd">    datapath : str</span>
<span class="sd">        The path in which data are to be stored base on the</span>
<span class="sd">        current UT date</span>

<span class="sd">    logpath : str</span>
<span class="sd">        The path and file to which logs from this module are saved</span>

<span class="sd">    tempC : int</span>
<span class="sd">        A variable to hold the temperature value provided by the</span>
<span class="sd">        local site weather station</span>

<span class="sd">    rh : int</span>
<span class="sd">        A variable to hold the relative humidity as provided by</span>
<span class="sd">        the local site weather station</span>

<span class="sd">    moonillum : int</span>
<span class="sd">        The percent current moon illumination</span>

<span class="sd">    moonalt : int</span>
<span class="sd">        The moon&#39;s current altitude above the horizon</span>

<span class="sd">    sunalt : int</span>
<span class="sd">        The sun&#39;s current altitude above or below the horizon</span>

<span class="sd">    lststr : str</span>
<span class="sd">        The current local sidereal time as a string</span>

<span class="sd">    testif : str</span>
<span class="sd">        A keyword from the FITS header to test whether the header</span>
<span class="sd">        has been modified.</span>

<span class="sd">    obss : obj</span>
<span class="sd">        Instance of the obsScheduler class from the scheduler</span>
<span class="sd">        module</span>

<span class="sd">    bc : obj</span>
<span class="sd">        Instance of the BrokerComm class from the BrokerComm</span>
<span class="sd">        module</span>

<span class="sd">    brokerMessage : dict</span>
<span class="sd">        The raw, unparsed, message or data of a stomp message</span>

<span class="sd">    config_file : str</span>
<span class="sd">        The path and file to the json configuration file</span>

<span class="sd">    header_file : str</span>
<span class="sd">        The path to the file containing the text version of the</span>
<span class="sd">        header file for use by astropy.fits.Header.fromtextfile</span>

<span class="sd">    cadence : str</span>
<span class="sd">        The frequency of data acquisition. Default is 60 seconds.</span>

<span class="sd">    publisher : str</span>
<span class="sd">        A variable holding the name of the topic to which</span>
<span class="sd">        messages sent from protoLoFits are to be sent. This </span>
<span class="sd">        corresponds to the telemStat topic as defined in the </span>
<span class="sd">        allsky config.json file.</span>

<span class="sd">    data : str</span>
<span class="sd">        A variable holding the name of the topic to which data</span>
<span class="sd">        are to be received. This corresponds to the fitsData </span>
<span class="sd">        topic as defined within the allsky config.json file.</span>

<span class="sd">    sun_ang_set : str</span>
<span class="sd">        The threshold sun angle which defines the angle of sunset</span>
<span class="sd">        as it is defined in the allsky config.json file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brokerMessage</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seqno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="s1">&#39;0001&#39;</span><span class="p">,</span> <span class="s1">&#39;0001&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span> <span class="o">=</span> <span class="n">log_obj</span><span class="o">.</span><span class="n">listener_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonillum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moonalt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sunalt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lststr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testif</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obss</span> <span class="o">=</span> <span class="n">ObsScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">BrokerComm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brokerMessage</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;.allsky/config.json&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;.allsky/header.txt&#39;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cfg_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cadence</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="s1">&#39;cadence&#39;</span><span class="p">][</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="s1">&#39;topic&#39;</span><span class="p">][</span><span class="s1">&#39;topic1&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="s1">&#39;topic&#39;</span><span class="p">][</span><span class="s1">&#39;topic0&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sun_ang_set</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">[</span><span class="s1">&#39;sunang&#39;</span><span class="p">][</span><span class="s1">&#39;sun_ang_set&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<div class="viewcode-block" id="MessageInterface.lineno"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.lineno">[docs]</a>    <span class="k">def</span> <span class="nf">lineno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the line number which corresponds to the line in</span>
<span class="sd">        the source code from which the log message is generated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            inspect.currentframe() : str</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;{inspect.currentframe().f_back.f_lineno:03d}:&#39;</span></div>

<div class="viewcode-block" id="MessageInterface.environmental"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.environmental">[docs]</a>    <span class="k">def</span> <span class="nf">environmental</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve weather data from the site weather station. The</span>
<span class="sd">        relative humidity is used to determine when the camera&#39;s</span>
<span class="sd">        dew heater should turn on. Temerature and humidity are </span>
<span class="sd">        written to the data file header.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxdata : tuple</span>
<span class="sd">            Data includes temperature in celcius and humidity </span>
<span class="sd">            percent.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Retrieving environmental data.&#39;</span><span class="p">)</span>

        <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;meteobridge&#39;</span>
        <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;meteobridge&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">password_mgr</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPPasswordMgrWithDefaultRealm</span><span class="p">()</span>
            <span class="n">top_level_url</span> <span class="o">=</span> <span class="s2">&quot;http://10.10.115.22/cgi-bin/livedataxml.cgi&quot;</span>
            <span class="n">password_mgr</span><span class="o">.</span><span class="n">add_password</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_level_url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">HTTPBasicAuthHandler</span><span class="p">(</span><span class="n">password_mgr</span><span class="p">)</span>
            <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">top_level_url</span><span class="p">)</span>
            <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">top_level_url</span><span class="p">)</span>

            <span class="n">xmlstr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">xmlstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

            <span class="n">xmlstr</span> <span class="o">=</span> <span class="n">xmlstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">datain</span> <span class="o">=</span> <span class="n">Et</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xmlstr</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">datain</span><span class="o">.</span><span class="n">attrib</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tempC</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rh</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hum&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} {str(error)}&#39;</span><span class="p">)</span>

        <span class="n">wxdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rh</span>
        <span class="k">return</span> <span class="n">wxdata</span></div>

<div class="viewcode-block" id="MessageInterface.sun_moon"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.sun_moon">[docs]</a>    <span class="k">def</span> <span class="nf">sun_moon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve current ephemeris information including sun</span>
<span class="sd">        altitude, moon altitude, moon % illumination and the local</span>
<span class="sd">        sideral time at the start of an exposure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sunmoon : tuple</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lat</span><span class="p">,</span> <span class="n">longit</span><span class="p">,</span> <span class="n">elev</span> <span class="o">=</span> <span class="s1">&#39;34.7443&#39;</span><span class="p">,</span> <span class="s1">&#39;-111.4223&#39;</span><span class="p">,</span> <span class="mi">2361</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">longit</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">elev</span><span class="p">)</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s1">&#39;US/Mountain&#39;</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">altaz</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
        <span class="n">sun</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="n">moon</span> <span class="o">=</span> <span class="n">get_moon</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;apparent&#39;</span><span class="p">)</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">hms</span>
        <span class="n">lsth</span><span class="p">,</span> <span class="n">lstm</span><span class="p">,</span> <span class="n">lsts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lstss</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lststr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">lsth</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">lstm</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">lsts</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">lstss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">moonfz</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">moon_illumination</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="c1"># self.moonillum = f&#39;{moonfz * 100:04.1f}&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonillum</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:2.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moonfz</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">moonget</span> <span class="o">=</span> <span class="n">moon</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz</span><span class="p">)</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moonalt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:2.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moonget</span><span class="p">)</span>
        <span class="n">sunget</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz</span><span class="p">)</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sunalt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:2.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sunget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Retrieving ephemeris data.&#39;</span><span class="p">)</span>
        <span class="n">sunmoon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lststr</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sunalt</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonalt</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moonillum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sunmoon</span></div>

<div class="viewcode-block" id="MessageInterface.fits_header"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.fits_header">[docs]</a>    <span class="k">def</span> <span class="nf">fits_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives the data in the form of a 64-bit string via the</span>
<span class="sd">        activemq broker. The data header is separated from the</span>
<span class="sd">        data and edited with the removal of undesired keywords</span>
<span class="sd">        while several new keywords are appended. Currently 11 </span>
<span class="sd">        keywords are removed and 20 keywords are appended.</span>

<span class="sd">        .. warning:: </span>
<span class="sd">            !!! Developer Warning !!!</span>
<span class="sd">            Within the fits_header() method:</span>
<span class="sd">            If the order of keywords is changed that change must</span>
<span class="sd">            also be reflected in the indices of the list insertions below.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data - 64-bit encoded string</span>
<span class="sd">            The data contain both the fits header and data.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lastimg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">utdate</span> <span class="o">+</span> <span class="s1">&#39;_*.fits&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lastimg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">seq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seqno</span>
            <span class="n">datafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seqno</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">lastimg</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_0001.fits&#39;</span>
            <span class="n">datafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">lastimg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="s1">&#39;0001&#39;</span>

        <span class="n">wxdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environmental</span><span class="p">()</span>
        <span class="n">sunmoon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sun_moon</span><span class="p">()</span>

        <span class="n">msghdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">unixtime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msghdr</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
        <span class="n">hdr_tstamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">unixtime</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">hdr_conlen</span> <span class="o">=</span> <span class="n">msghdr</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Msg header timestamp: </span><span class="si">{hdr_tstamp}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Message size {int(hdr_conlen)} == 3866880 = {int(hdr_conlen) == 3866880}&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">hdr_conlen</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3866880</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Message size = </span><span class="si">{hdr_conlen}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">imgdata</span> <span class="o">=</span> <span class="n">ImageHDU</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">prihdr</span> <span class="o">=</span> <span class="n">imgdata</span><span class="o">.</span><span class="n">header</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;DATE-OBS&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imgtype</span> <span class="o">=</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;FRAME&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">imgtype</span> <span class="o">=</span> <span class="s1">&#39;Error&#39;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">testif</span> <span class="o">=</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;PIXSIZE1&#39;</span><span class="p">]</span>

                    <span class="c1"># Delete unused INDI keywords from the header</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;TELESCOP&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;OBSERVER&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;FRAME&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;SCALE&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;PIXSIZE1&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;PIXSIZE2&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;XBINNING&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;YBINNING&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;INSTRUME&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">prihdr</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span>

                    <span class="c1"># Append specified keywords to file header</span>
                    <span class="c1"># Experimental code 9 December 2019</span>

                    <span class="n">header_text</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">fromtextfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_file</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">oflist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">header_text</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imgdata</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">imgdata</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                    <span class="c1"># Test code</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LST-OBS&#39;</span><span class="p">,</span> <span class="n">sunmoon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;IMGTYPE&#39;</span><span class="p">,</span> <span class="n">imgtype</span><span class="p">)</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SEQNUM&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seqnum</span><span class="p">))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TEMPAMB&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">wxdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;HUMIDITY&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">wxdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SUN_ALT&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sunmoon</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;MOON_ALT&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sunmoon</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;MOONILLU&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">sunmoon</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DATAMAX&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxval</span><span class="p">))</span>
                    <span class="n">oflist</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DATAMIN&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">minval</span><span class="p">))</span>


                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_text</span><span class="p">)):</span>
                        <span class="n">keyword</span> <span class="o">=</span> <span class="n">oflist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">oflist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="n">header_text</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>

                        <span class="k">if</span> <span class="s1">&#39;astropy.io.fits.card&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                        <span class="n">prihdr</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comment</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                       <span class="c1"># print(f&#39;{keyword:8s}= {str(value):20s}/ {comment:45s}&#39;)</span>

                    <span class="c1"># End experimental code</span>

                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    prihdr.append((&#39;LST-OBS &#39;, sunmoon[0], &#39;Local Sidereal Time of exposure start&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;CREATOR &#39;, &#39;LOASC_INDI&#39;, &#39;File creator&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;CAMERA  &#39;, &#39;SX Superstar 1.10&#39;, &#39;Manufacturer  driver version&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;MODEL   &#39;, 25, &#39;Camera model number&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;PIXSIZE &#39;, 4.65, &#39;Pixel Size in Microns&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;CCDSUM  &#39;, &#39;1 1&#39;, &#39;On Chip binned summation&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;IMGTYPE &#39;, imgtype, &#39;Image Type&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBJECT  &#39;, &#39;Sky Above DCT&#39;, &#39;Object Name&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBSERVAT&#39;, &#39;DCT Telescope&#39;, &#39;Observatory&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBSLOCAT&#39;, &#39;Happy Jack, AZ&#39;, &#39;Observatory Location&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBSLAT  &#39;, 34.89708, &#39;Observatory Latitude (degrees)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBSLONG &#39;, -111.5367, &#39;Observatory Longitude (degrees)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;OBSALT  &#39;, 2202., &#39;Observatory Altitude (meters)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;INSTRUME&#39;, &#39;DCT_ALLSKY&#39;, &#39;Instrument&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;SEQNUM  &#39;, int(self.seqnum), &#39;File Sequence Number&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;TEMPAMB &#39;, float(wxdata[0]), &#39;Mean Ambient Temperature in deg C&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;HUMIDITY&#39;, int(wxdata[1]), &#39;Relative Humidity (percent)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;SUN_ALT &#39;, f&#39;{sunmoon[1]:2.2f}&#39;, &#39;Altitude of Sun (degrees)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;MOON_ALT&#39;, f&#39;{sunmoon[2]:2.2f}&#39;, &#39;Altitude of Moon (degrees)&#39;), end=True)</span>
<span class="sd">                    prihdr.append((&#39;MOONILLU&#39;, f&#39;{sunmoon[3]:2.2f}&#39;, &#39;Moon illumination (percent)&#39;), end=True)</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} FITS header KeyError: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

                <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">imgdata</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">imgdata</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fileconf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fileconf</span><span class="p">:</span>
                        <span class="n">writetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">datafile</span><span class="p">))</span> \
                                    <span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} </span><span class="si">{datafile[-18:]}</span><span class="s1"> Image write confirmed.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} File write time </span><span class="si">{writetime}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">file_error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_error</span><span class="p">))</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} In fits_ops() method, error </span><span class="si">{error}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} in message sent to </span><span class="si">{msghdr[&quot;destination&quot;]}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MessageInterface.on_data"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive data as sent by the camera module.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Image data received.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">brokerMessage</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logmsg</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{self.lineno()} Processing data.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fits_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brokerMessage</span><span class="p">[</span><span class="mi">0</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">brokerMessage</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="MessageInterface.send_message"><a class="viewcode-back" href="../protoLoFits.html#protoLoFits.MessageInterface.send_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send messages on the telemStat topic as defined within the</span>
<span class="sd">        allsky config.json configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            The body of the message which is the string &#39;True&#39; and</span>
<span class="sd">            originates from the camera module.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span><span class="o">.</span><span class="n">sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span></div></div>


<span class="n">MessageInterface</span><span class="p">()</span>  <span class="c1"># Comment during docs build.</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2019, Len Bright.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 2.2.1. &nbsp;
    Last built 17 Dec 2019. <br/>
  </p>
</footer>
  </body>
</html>
